# =============================================================================
# PostgreSQL Database Component
# =============================================================================
name: postgres
version: 1.0.0
category: infrastructure
validated: 2024-12-13

description: PostgreSQL relational database for application data storage.

# =============================================================================
# DOCKER CONFIGURATION
# =============================================================================
docker:
  image: postgres:16
  port: 5432
  
  compose_snippet: |
    postgres:
      image: postgres:16
      container_name: ${APP_NAME}-postgres
      restart: unless-stopped
      environment:
        POSTGRES_USER: ${POSTGRES_USER:-appuser}
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-localdevpassword123}
        POSTGRES_DB: ${POSTGRES_DB:-appdb}
      volumes:
        - postgres_data:/var/lib/postgresql/data
        - ./config/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      ports:
        - "5432:5432"
      healthcheck:
        test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-appuser}"]
        interval: 10s
        timeout: 5s
        retries: 5

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================
environment:
  required:
    - POSTGRES_PASSWORD: Database password
  optional:
    - POSTGRES_USER: "appuser"
    - POSTGRES_DB: "appdb"

# =============================================================================
# AWS DEPLOYMENT
# =============================================================================
aws:
  service: RDS PostgreSQL
  instances:
    development: db.t3.micro
    production: db.t3.small
  features:
    - Multi-AZ for production
    - Automated backups
    - Encryption at rest

# =============================================================================
# INIT SQL TEMPLATE
# =============================================================================
template:
  init_sql: |
    -- Create application database
    CREATE DATABASE IF NOT EXISTS appdb;
    
    -- Create tables
    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        email VARCHAR(255) UNIQUE NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    CREATE TABLE IF NOT EXISTS audit_log (
        id SERIAL PRIMARY KEY,
        user_id INTEGER REFERENCES users(id),
        action VARCHAR(100) NOT NULL,
        details JSONB,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
